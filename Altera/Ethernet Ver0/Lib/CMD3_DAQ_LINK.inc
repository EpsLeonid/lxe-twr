%
	Файл содержит декларацию констант медленного линка КМД-3, и предназначен 
для включения в файлы унифицированных реализаций  Модулей UP_Link  и Down_Link .
-- Рубан, Козырев, 4592.
%

-- Transaction Layer Constants, text description file - DAQ_DTR.doc
-- Константы - прервичные параметры протокола последовательной связи, определяемые протоколом обмена КМД-3
CONSTANT	Link_Clock		=	25; -- частота в МГц-ах (целых), на которой дается синхронизация
CONSTANT	Link_Speed		=	25; -- Скорость в Мбитах в секунду (целых), на которой работает Линк
CONSTANT	WordsToGoUp		=	63 ; -- Количество возвращаемых слов данных, кроме заголовка
CONSTANT	WordsToGoDown	=	8 ;  -- число принимаемых слов данных
CONSTANT	COMMAND_SIZE    = 1+5+2; -- размер команды ( 1 стартовый + 5 код операции + 2 доп.до нечетности/его инверсия)
CONSTANT	WORD_WIDTH      = 16; -- размер слова данных
CONSTANT	PAUSE           = 0; 
constant	Dead_Time		=	200;  -- ns, Мертвое время - защитный промежуток от конца цикла до начала следующего, периодов RefClock. 
CONSTANT	CRC_Check		=	"CCITT"; --  Тип Проверки по CRC
CONSTANT	PolinomPower	=	16;
-- Константы - параметры протокола последовательной связи, типично вычисляемые,
-- вторично (неявно) определяемые протоколом обмена СМД-3
-- Common Constants
CONSTANT BitOfReverse           = COMMAND_SIZE + PAUSE + ((WordsToGoDown + 1 ) * (WORD_WIDTH +PAUSE)) + COMMAND_SIZE ;
CONSTANT BitOfAnswerStart       = BitOfReverse + COMMAND_SIZE; -- Номер бита обмена соответствующий стартовому биту ответной посылки
CONSTANT HeaderSize 			= COMMAND_SIZE+PAUSE+WORD_WIDTH+PAUSE; -- размер заголовка отправляемого обратно в линк
CONSTANT MaxNumberOfBit 		= BitOfAnswerStart+HeaderSize+(WordsToGoUp + 1)*((WORD_WIDTH)+PAUSE); -- конец цикла работы
CONSTANT OrderOfBitNumber 		= FLOOR (LOG2(MaxNumberOfBit))+1;  -- определение размера счетчика

-- Up_Link
CONSTANT Bit_of_Header_UP_Reload   = BitOfAnswerStart + COMMAND_SIZE + PAUSE; -- Номер бита с точки зрения счетчика Up Link-а, по которому начинается передача первого слова. Счетчик Up Link-а начинает считать после опознания команды
CONSTANT Bit_of_CRC_Reload		   = BitOfAnswerStart+HeaderSize+(WordsToGoUp-1)*((WORD_WIDTH+PAUSE)); -- Номер бита с точки зрения счетчика Up Link-а, по которому начинается передача контрольной суммы (CRC)

-- Down_Link
CONSTANT Bit_of_Header_DOWN_Reload = 1 + COMMAND_SIZE + PAUSE;
CONSTANT BitOfAnswerWindowStart    = BitOfReverse + COMMAND_SIZE*2; -- Номер бита с точки зрения счетчика Down Link-а, по которому начинается ожидание ответной посылки. 
CONSTANT BitOfAnswerWindowEnd      = BitOfAnswerStart + COMMAND_SIZE*4;-- Номер бита с точки зрения счетчика Down Link-а, по которому заканчивается ожидание ответной посылки. Константа подобрана с для длины кабеля не более 15 метров.


-- Command Layer Constants, text description continued
-- Команды, обрабатываемые модулями, паузы включены
-- Полный набор команд, который должны понимать платы в ССД КМД-3
Constant CMDL_Cfg_Read		=	B"10000010";    -- Чтение памати редиректора
Constant CMDL_Cfg_Write		=	B"10001001";	-- Запись в память редиректора

Constant CMDL_Exe_Read_000	=	B"11000001";	-- Чтение 0
Constant CMDL_Exe_Read_010	=	B"11010010";	-- Чтение 1
Constant CMDL_Exe_Read_100	=	B"11100010";	-- Чтение 2
Constant CMDL_Exe_Read_110	=	B"11110001";	-- Чтение 3

Constant CMDL_Exe_Write_001	=	B"11001010";	-- Запись 0
Constant CMDL_Exe_Write_011	=	B"11011001";	-- Запись 1
Constant CMDL_Exe_Write_101	=	B"11101001";	-- Запись 2
Constant CMDL_Exe_Write_111	=	B"11111010";	-- Запись 3
-- CMDL is acronim of CoMmanD Layer
% Первый бит (В6) (после стартового) определяет HIHG=> исполняемая команда LOW=>конфигурационная
Два бита (В5 и В4) дают номер Командного Листа и, соответственно, бит В3 - тип Листа на чтение/запись.
Бит В2 зарезервирован под расширение поля команд.
%

%
Исходные утверждения по Редиректору:
1. Синхронный Линк является пакетным средством связи в Системе Сбора Данных.
2. В разных Системах Детектора будут применяться одни и те же унифицированные Модули Оцифровки,
слегка различаясь по набору задействованных функций и количеству каналов.
3. Для периодически-постоянного мониторирования состояния электроники, размещенной непосредственно на
Детекторе, потребуется доступ к ресурсам Модулей Оцифровки, не используемым в работе напрямую.
Выводы:
1. Требуется обеспечить доступ Линка ко ВСЕМ внутренним ресурсам Модулей Оцифровки.
2. Крайне желательно обеспечить унификацию метода доступа.
3. Необходимо обеспечить пакетность доступа.
Решенние:
Синхронный Линк оборудуется специальным ресурсом, называемым Редиректор. Главной составляющей Редиректора 
является ОЗУ, состоящее из нескольких страниц. Каждая страница заполнена Списком Команд доступа ко внитренним 
ресурсам Модуля Оцифровки. Номер активной страницы, выполняемой в данный момент, определяется кодом операции.

Следует выделить две КОНФИГУРАЦИОННЫЕ команды, необходимые для программирования доступа через 
интерфейс "Синхронный Линк".
	CMDL_Cfg_Read  -  Чтение из памяти Редиректора. Первое слово нисходящих (входящих) данных интерпретируется 
как  адрес базовой ячейки, остальные 7-мь слов игнорируются. Возвращается 63 слова из Списка Команд, начиная с
базовой ячейки. 
	CMDL_Cfg_Write -  Запись в память Редиректора. Первое слово нисходящих (входящих) данных интерпретируется 
как адрес базовой ячейки, следующие за ним 7-мь слов записываются в память последовательно. Возвращается 63 
слова из Списка Команд, как для предыдущей команды.
С помощью этих команд прописывается и проверяется вся память редиректора.

Таким образом, за вычетом двух команд конфигурации Редиректора, имеем 6 команд на собственно доступ к данным 
Модулей Оцифровки. Если сбросить оковы, налагаемые тов.Юдиным (два такта паузы), то можно иметь до 30 команд.
 Первое слово нисходящих (входящих) данных для этих 6-ти ИСПОЛНИТЕЛЬНЫХ команд 
интерпретируется как номер события в заходе.
Предлагается поделить их между командами, делающими чтения (StandardRead, Digitizer_Read, 
AlternatedRead), и командами, делающими запись (StandardWrite, AlternateWrite,etc.) пополам.
По командам чтения будут происходить обращения ко внутренним ресурсам платы-оцифровщика, соответственно
адресам в текущей странице, полученные данные возвращаются в Линк.
По командам записи так же происходят обращения к внутренним ресурсам платы-оцифровщика. При этом и адреса, 
и данные для записи берутся из текущей страницы Редиректора. В принципе, возвращать при этом что-либо 
в линк не надо, но можно копировать в него данные, записываемые во внутренние ресурсы. (Явно
указываю, что запись происходит не из тех 7-ми слов, а из Командного Листа, ассоциированного с Кодом Операции.)
Запись такого рода необходима, например, для записи установок в плату, для блокировки/разблокировки Триггера
и пересчеток на время перепусков пучков ВЭПП. Для плат типа УФО команды блокировки так же актуальны, т.к.
они исползуют прецизионные чопперные усилители, время восстановления которых после перегрузки составляет 0.1с!!!
Т.о. каждое устройство может иметь как собственный набор данных, возвращаемых в ССД СМД-3, так и собственный 
набор реакций на стандартные действия в Системе.
%

%
Список терминов.
МЧС - Модуль Частот и Синхронизации - Верхний в иерархии ССД блок,
обеспечивающий синхронизацию Триггера и ССД с Фазой ВЭПП.
ГИБДД - Главный Интерфейсный Блок Доставки Данных (он же селивановская коробка).
Обеспечивает разветвление и раздачу Команд от МЧС на Оцифровщики.
Up_Link - Линк, "направленный" вверх ( с точки зрения процессора, упроавляющего ССД)
Down_Link - Линк, "направленный" вниз ( с точки зрения процессора, упроавляющего ССД)
Пресэмплер - узел автоматической подстройки фазы, компенсирующий возможную разность 
задержки фазы и данных в селивановской коробке.
Редиректор - командный автомат доступа с Линка на шину Блоков Триггера и Оцифровки. Реализует механизм
командных листов, а-ля стандартный ПВ.
%
%Краткое изложение Командного Уровня спецификации Линка (Command Layer, previose layers are described
in DAQ_DTR.doc paper)
Исходные утверждения по Редиректору:
1. Синхронный Линк является пакетным средством связи в Системе Сбора Данных. Траффик Линка несимметричный,
с передачей Команд "вниз" и возвращением данных "вверх".
2. В разных Системах Детектора будут применяться одни и те же унифицированные Модули Оцифровки,
слегка различаясь по набору задействованных функций и количеству каналов.
3. Для периодически-постоянного мониторирования состояния электроники, размещенной непосредственно на
Детекторе, потребуется обеспечить доступ к ресурсам Модулей Оцифровки, не используемым в работе напрямую.
Выводы:
1. Требуется обеспечить доступ Линка ко ВСЕМ внутренним ресурсам Модулей Оцифровки.
2. Крайне желательно обеспечить унификацию метода доступа.
3. Необходимо обеспечить пакетность доступа при несимметричном траффике.
Решенние:
Синхронный Линк оборудуется специальным ресурсом, называемым Редиректор. Главной составляющей Редиректора 
является ОЗУ, состоящее из нескольких страниц. Каждая страница заполнена Списком Команд доступа ко внитренним 
ресурсам Модуля Оцифровки. Номер активной страницы, выполняемой в данный момент, определяется кодом операции.

Следует выделить две КОНФИГУРАЦИОННЫЕ команды, необходимые для программирования доступа через 
интерфейс "Синхронный Линк".
	CMDL_Cfg_Read  -  Чтение из памяти Редиректора. Первое слово нисходящих (входящих) данных интерпретируется 
как  адрес "базовой" ячейки (оффсет внутри памяти Редиректора) , остальные 7-мь слов игнорируются. 
Возвращается 63 слова из Списка Команд, начиная с базовой ячейки. 
	CMDL_Cfg_Write -  Запись в память Редиректора. Первое слово нисходящих (входящих) данных интерпретируется 
как адрес базовой ячейки, следующие за ним 7-мь слов записываются в память последовательно. Возвращается 63 
слова из Списка Команд, как для предыдущей команды.
С помощью этих команд прописывается и проверяется вся память Редиректора.

Таким образом, за вычетом двух команд конфигурации Редиректора, имеем 8 команд на собственно доступ к данным 
Модулей Оцифровки. Если сбросить оковы, налагаемые тов.Юдиным (два такта паузы), то можно иметь до 30 команд.
 Первое слово нисходящих (входящих) данных для этих 6-ти ИСПОЛНИТЕЛЬНЫХ команд 
интерпретируется как номер события в заходе.
Предлагается поделить их между командами, делающими чтения (StandardRead, Digitizer_Read, 
AlternatedRead), и командами, делающими запись (StandardWrite, AlternateWrite,etc.) пополам.
По командам чтения будут происходить обращения ко внутренним ресурсам платы-оцифровщика, соответственно
адресам в текущей странице, полученные данные возвращаются в Линк.
По командам записи так же происходят обращения к внутренним ресурсам платы-оцифровщика. При этом и адреса, 
и данные для записи берутся из текущей страницы Редиректора. В принципе, возвращать при этом что-либо 
в линк не надо, но можно копировать в него данные, записываемые во внутренние ресурсы. (Явно
указываю, что запись происходит не из тех 7-ми слов, а из Командного Листа, ассоциированного с Кодом Операции.)
Запись такого рода необходима, например, для записи установок в плату, для блокировки/разблокировки Триггера
и пересчеток на время перепусков пучков ВЭПП. Для плат типа УФО команды блокировки так же актуальны, т.к.
они исползуют прецизионные чопперные усилители, время восстановления которых после перегрузки составляет 0.1с!!!
Т.о. каждое устройство может иметь как собственный набор данных, возвращаемых в ССД СМД-3, так и собственный 
набор реакций на стандартные действия в Системе.
%
% Общий смысл таков, что по мере работы линка модуль с параллельной стороны  предпринимет действия:
	1. При обнаружении валидного Кода Операции (в дальнейшем - Команды), он выставляется 
на  OpCodeData[6..0] и сопровождается сигналом LinkMessage. Сигнал стоит все время работы Линка.
	2. По концу приема очередного слова или по началу передачи очередного слова Модуль в режиме Master предпринимает
действия по захвату шины и доступу ко внутренним ресурсам платы-оцифровщика. Здесь Модуль выступает как
Мастер шины. Формальная сторона действий аналогична описанной в Модуле КАМАК. 
Суть обмена определяется содержимым активной страницы памяти Редиректора. 

 От Пользователя требуется только обеспечить реакцию на запрос Модуля,
не превышающую 18..16 тактов линка. Число запросов на обмен определяется по "Соглашением Линка" (через константы).
%
